# V3 å¾·å·æ‰‘å…‹é¡¹ç›®

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

V3ç‰ˆæœ¬æ˜¯ä¸€ä¸ªå®Œå…¨é‡æ„çš„å¾·å·æ‰‘å…‹é¡¹ç›®ï¼Œä¸¥æ ¼éµå¾ªCQRSæ¨¡å¼å’Œåˆ†å±‚æ¶æ„ï¼Œæ”¯æŒ1000æ‰‹ç‰Œçš„é«˜å¼ºåº¦ç»ˆææµ‹è¯•ã€‚

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### CQRSåˆ†å±‚è®¾è®¡
```
UIå±‚ (Streamlit/CLI)
    â†“ åªå…è®¸è°ƒç”¨
Applicationå±‚ (CommandService, QueryService, GameFlowService...)
    â†“ åªå…è®¸è°ƒç”¨  
Coreå±‚ (çŠ¶æ€æœº, ç­¹ç ç®¡ç†, å¡ç‰Œç³»ç»Ÿ...)
```

### ğŸ›¡ï¸ åä½œå¼Šç³»ç»Ÿ
- **CoreUsageChecker**: ç¡®ä¿æ‰€æœ‰æµ‹è¯•ä½¿ç”¨çœŸå®çš„coreæ¨¡å—
- **StateConsistencyChecker**: éªŒè¯ç­¹ç å®ˆæ’å’Œæ¸¸æˆçŠ¶æ€ä¸€è‡´æ€§
- **åä½œå¼ŠéªŒè¯**: æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡anti-cheatæ£€æŸ¥

## ğŸ® æ ¸å¿ƒåŠŸèƒ½

### æ¸¸æˆç³»ç»Ÿ
- âœ… **å®Œæ•´å¾·å·æ‰‘å…‹è§„åˆ™**: æ”¯æŒ2-10äººæ¸¸æˆ
- âœ… **çŠ¶æ€æœº**: ç²¾ç¡®çš„é˜¶æ®µç®¡ç† (INIT â†’ PRE_FLOP â†’ FLOP â†’ TURN â†’ RIVER â†’ FINISHED)
- âœ… **ç­¹ç ç³»ç»Ÿ**: ä¸¥æ ¼çš„ç­¹ç å®ˆæ’éªŒè¯
- âœ… **ä¸‹æ³¨å¼•æ“**: æ”¯æŒfoldã€checkã€callã€raiseã€all-in
- âœ… **è¾¹æ± è®¡ç®—**: ç²¾ç¡®çš„è¾¹æ± åˆ†é…ç®—æ³•
- âœ… **AIç©å®¶**: åŸºäºTreysçš„æ™ºèƒ½å†³ç­–

### CQRSæ¶æ„æœåŠ¡
- âœ… **GameCommandService**: å¤„ç†æ‰€æœ‰çŠ¶æ€å˜æ›´å‘½ä»¤
- âœ… **GameQueryService**: å¤„ç†æ‰€æœ‰æŸ¥è¯¢æ“ä½œ
- âœ… **GameFlowService**: æ¸¸æˆæµç¨‹æ§åˆ¶æœåŠ¡
- âœ… **TestStatsService**: æµ‹è¯•ç»Ÿè®¡æœåŠ¡

## ğŸ† é‡å¤§æˆå°±: ç»ˆæµ‹CQRSé‡æ„ (2024-12-05)

### ğŸ“Š Phase 1-2 æˆåŠŸæŒ‡æ ‡
- âœ… **å¿«é€Ÿç‰ˆç»ˆæµ‹**: 15æ‰‹ç‰Œï¼Œ100%å®Œæˆç‡ï¼Œ105æ‰‹/ç§’
- âœ… **å®Œæ•´ç‰ˆç»ˆæµ‹**: 50æ‰‹ç‰Œï¼Œ100%å®Œæˆç‡ï¼Œ110æ‰‹/ç§’
- âœ… **ç­¹ç å®ˆæ’**: å®Œç¾å®ˆæ’ï¼Œ0è¿å
- âœ… **æ¶æ„åˆè§„**: UIå±‚å®Œå…¨éµå¾ªCQRSæ¨¡å¼
- âœ… **æ€§èƒ½åŸºå‡†**: è¿œè¶…é¢„æœŸ5æ‰‹/ç§’ç›®æ ‡
- âœ… **AIå†³ç­–é‡æ„**: UIå±‚éšæœºé€»è¾‘å®Œå…¨ç§»é™¤

### ğŸ”„ æ¶æ„é‡æ„æˆæœ

#### Phase 1: GameFlowService
**é‡æ„å‰ (è¿è§„)**:
- UIå±‚åŒ…å«200+è¡Œå¤æ‚ä¸šåŠ¡é€»è¾‘
- è¿è§„è°ƒç”¨core/aiæ¨¡å—
- ç›´æ¥æ§åˆ¶æ¸¸æˆæµç¨‹

**é‡æ„å (åˆè§„)**:
- UIå±‚è°ƒç”¨ä¸€è¡Œ`flow_service.run_hand()`
- ä¸¥æ ¼éµå¾ªCQRSæ¨¡å¼
- ä¸šåŠ¡é€»è¾‘å®Œå…¨åœ¨Applicationå±‚

#### Phase 2: AIå†³ç­–æœåŠ¡
**é‡æ„å‰ (è¿è§„)**:
- UIå±‚ç›´æ¥ä½¿ç”¨`random.choice()`
- AIå†³ç­–é€»è¾‘åˆ†æ•£åœ¨UIå±‚
- ç¡¬ç¼–ç æ¦‚ç‡é…ç½®

**é‡æ„å (åˆè§„)**:
- ä½¿ç”¨`query_service.make_ai_decision()`
- å‚æ•°åŒ–AIé…ç½®
- å®Œå–„é”™è¯¯å¤„ç†æœºåˆ¶

### ğŸš€ æ–°å¢æ ¸å¿ƒæœåŠ¡

#### GameFlowService
æ¸¸æˆæµç¨‹æ§åˆ¶æœåŠ¡ï¼š
```python
class GameFlowService:
    def run_hand(self, game_id: str, config: HandFlowConfig) -> CommandResult
    def force_finish_hand(self, game_id: str, max_attempts: int = 10) -> CommandResult
    def advance_until_finished(self, game_id: str, max_attempts: int = 10) -> CommandResult
```

#### AIå†³ç­–æœåŠ¡å¢å¼º
```python
# Applicationå±‚ç»Ÿä¸€AIå†³ç­–æ¥å£
def make_ai_decision(self, game_id: str, player_id: str, 
                    ai_config: Optional[Dict[str, Any]] = None) -> QueryResult
```

## ğŸ§ª æµ‹è¯•ç³»ç»Ÿ

### æµ‹è¯•å±‚çº§
1. **å•å…ƒæµ‹è¯•**: æµ‹è¯•å•ä¸ªæ¨¡å—åŠŸèƒ½
2. **å±æ€§æµ‹è¯•**: éªŒè¯æ•°å­¦ä¸å˜é‡ï¼ˆç­¹ç å®ˆæ’ç­‰ï¼‰
3. **é›†æˆæµ‹è¯•**: æµ‹è¯•è·¨æ¨¡å—åä½œ
4. **ç»ˆææµ‹è¯•**: 1000æ‰‹ç‰ŒStreamlitæ¨¡æ‹Ÿ

### TDDå¼€å‘è§„èŒƒ
- âœ… **Red-Green-Refactor**: ä¸¥æ ¼TDDå¾ªç¯
- âœ… **åä½œå¼ŠéªŒè¯**: æ¯ä¸ªæµ‹è¯•å¿…é¡»é€šè¿‡anti-cheatæ£€æŸ¥
- âœ… **95%+è¦†ç›–ç‡**: Coreæ¨¡å—é«˜è¦†ç›–ç‡è¦æ±‚
- âœ… **æ€§èƒ½åŸºå‡†**: æ‰€æœ‰æµ‹è¯•å¿…é¡»æ»¡è¶³æ€§èƒ½è¦æ±‚

### æµ‹è¯•å‘½ä»¤
```bash
# å•å…ƒæµ‹è¯•
.venv\Scripts\python -m pytest v3\tests\unit\ -v

# GameFlowServiceæµ‹è¯•
.venv\Scripts\python -m pytest v3\tests\unit\test_game_flow_service.py -v

# Phase 2 AIå†³ç­–é‡æ„éªŒè¯
.venv\Scripts\python -m pytest v3\tests\unit\test_phase2_ai_decision_refactor.py -v

# ç»ˆææµ‹è¯• (å¿«é€Ÿç‰ˆ)
.venv\Scripts\python -m pytest v3\tests\integration\test_streamlit_ultimate_user_experience_v3.py::test_streamlit_ultimate_user_experience_v3_quick -v

# ç»ˆææµ‹è¯• (å®Œæ•´ç‰ˆ)
.venv\Scripts\python -m pytest v3\tests\integration\test_streamlit_ultimate_user_experience_v3.py::test_streamlit_ultimate_user_experience_v3_full -v
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
v3/
â”œâ”€â”€ core/                   # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ state_machine/     # æ¸¸æˆçŠ¶æ€æœº
â”‚   â”œâ”€â”€ betting/           # ä¸‹æ³¨å¼•æ“
â”‚   â”œâ”€â”€ chips/             # ç­¹ç ç®¡ç†
â”‚   â”œâ”€â”€ deck/              # å¡ç‰Œç³»ç»Ÿ
â”‚   â”œâ”€â”€ pot/               # åº•æ± è®¡ç®—
â”‚   â”œâ”€â”€ eval/              # ç‰ŒåŠ›è¯„ä¼°
â”‚   â”œâ”€â”€ rules/             # æ¸¸æˆè§„åˆ™
â”‚   â”œâ”€â”€ invariant/         # ä¸å˜é‡æ£€æŸ¥
â”‚   â”œâ”€â”€ events/            # é¢†åŸŸäº‹ä»¶
â”‚   â””â”€â”€ snapshot/          # çŠ¶æ€å¿«ç…§
â”œâ”€â”€ application/           # åº”ç”¨æœåŠ¡å±‚
â”‚   â”œâ”€â”€ command_service.py # å‘½ä»¤æœåŠ¡
â”‚   â”œâ”€â”€ query_service.py   # æŸ¥è¯¢æœåŠ¡
â”‚   â”œâ”€â”€ game_flow_service.py # æ¸¸æˆæµç¨‹æœåŠ¡
â”‚   â””â”€â”€ test_stats_service.py # æµ‹è¯•ç»Ÿè®¡æœåŠ¡
â”œâ”€â”€ ai/                    # AIç©å®¶
â”‚   â”œâ”€â”€ Treys/            # Treys AIå®ç°
â”‚   â””â”€â”€ Dummy/            # ç®€å•AIå®ç°
â”œâ”€â”€ tests/                 # æµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ unit/             # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ property/         # å±æ€§æµ‹è¯•
â”‚   â”œâ”€â”€ integration/      # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ anti_cheat/       # åä½œå¼Šæ£€æŸ¥
â””â”€â”€ docs/                  # é¡¹ç›®æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè®¾ç½®
```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
.venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### è¿è¡Œæ¸¸æˆ
```bash
# è¿è¡Œç»ˆææµ‹è¯•ï¼ˆæ¨èï¼‰
.venv\Scripts\python -m pytest v3\tests\integration\test_streamlit_ultimate_user_experience_v3.py::test_streamlit_ultimate_user_experience_v3_quick -v
```

## ğŸ“š å¼€å‘æŒ‡å—

### æ–°åŠŸèƒ½å¼€å‘æµç¨‹
1. **åˆ†ææ¶æ„**: ç¡®å®šåŠŸèƒ½å±äºå“ªä¸ªå±‚çº§
2. **TDDå¼€å‘**: å…ˆå†™æµ‹è¯•ï¼Œå†å†™å®ç°
3. **åä½œå¼ŠéªŒè¯**: ç¡®ä¿æµ‹è¯•é€šè¿‡CoreUsageChecker
4. **é›†æˆæµ‹è¯•**: éªŒè¯ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ
5. **æ€§èƒ½éªŒè¯**: ç¡®ä¿æ»¡è¶³æ€§èƒ½è¦æ±‚

### ä»£ç è§„èŒƒ
- **æ¨¡å—è®¿é—®**: coreåªèƒ½å¯¼å…¥coreï¼Œapplicationå¯å¯¼å…¥coreï¼ŒUIåªèƒ½å¯¼å…¥application
- **å‘½åè§„èŒƒ**: PascalCaseç±»åï¼Œsnake_caseæ–¹æ³•å
- **ç±»å‹æ³¨è§£**: æ‰€æœ‰å…¬å…±æ–¹æ³•å¿…é¡»æœ‰ç±»å‹æ³¨è§£
- **æ–‡æ¡£å­—ç¬¦ä¸²**: ä½¿ç”¨Googleæ ¼å¼docstring

## ğŸ”¬ å…³é”®ç‰¹æ€§

### 1. ç­¹ç å®ˆæ’
ä¸¥æ ¼çš„ç­¹ç å®ˆæ’éªŒè¯ï¼Œç¡®ä¿æ¸¸æˆä¸­ç­¹ç æ€»æ•°æ°¸è¿œä¸å˜ï¼š
```python
æ€»ç­¹ç  = ç©å®¶ç­¹ç ä¹‹å’Œ + åº•æ± ç­¹ç  + è¾¹æ± ç­¹ç 
```

### 2. çŠ¶æ€æœºç®¡ç†
ç²¾ç¡®çš„æ¸¸æˆé˜¶æ®µæ§åˆ¶ï¼Œæ¯ä¸ªçŠ¶æ€è½¬æ¢éƒ½ç»è¿‡éªŒè¯ã€‚

### 3. åä½œå¼Šç³»ç»Ÿ
æ‰€æœ‰æµ‹è¯•å¿…é¡»ä½¿ç”¨çœŸå®çš„coreæ¨¡å—ï¼Œé˜²æ­¢mockæˆ–stubå½±å“æµ‹è¯•æœ‰æ•ˆæ€§ã€‚

### 4. CQRSæ¨¡å¼
ä¸¥æ ¼åˆ†ç¦»å‘½ä»¤(Command)å’ŒæŸ¥è¯¢(Query)æ“ä½œï¼Œç¡®ä¿æ¶æ„æ¸…æ™°ã€‚

## ğŸ é¡¹ç›®ç›®æ ‡

**ç»ˆæç›®æ ‡**: é€šè¿‡1000æ‰‹ç‰Œçš„ç»ˆææµ‹è¯•ï¼Œè¾¾åˆ°ä»¥ä¸‹æŒ‡æ ‡ï¼š
- âœ… å®Œæˆç‡ â‰¥99%
- âœ… ç”¨æˆ·è¡ŒåŠ¨æˆåŠŸç‡ â‰¥99%
- âœ… é›¶ç­¹ç å®ˆæ’è¿å
- âœ… é›¶ä¸å˜é‡è¿å
- âœ… æ€§èƒ½ â‰¥5æ‰‹/ç§’

**å½“å‰çŠ¶æ€**: Phase 1-2 å®Œæˆï¼ŒGameFlowService + AIå†³ç­–é‡æ„æˆåŠŸï¼Œå‡†å¤‡Phase 3

---

**æ›´æ–°æ—¶é—´**: 2024-12-05  
**ç‰ˆæœ¬**: V3.1.0 (CQRSé‡æ„ç‰ˆ) 