### TexasHoldem → Streamlit MVP 重构 PLAN（1 – 50）

> **说明**
>
> * **问题**：针对当前代码/架构缺陷或缺口
> * **方案**：解决思路与具体落地操作
> * **测试**：要编写或修改的测试，验证此项方案是否有效
> * 每条是**原子**、可独立执行的任务；按序号顺序依赖性最小化

| #                     | 问题                       | 方案                                                                                                                            | 测试                                                                            |
| --------------------- | ------------------------ | ----------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| **核心目录与模块边界**         |                          |                                                                                                                               |                                                                               |
| 1                     | 目录层级混杂，核心代码与 CLI 混放      | 在 `TexasHoldem/` 顶层新建 `core/`, `controller/`, `ui/` 目录并移动现有文件                                                                 | `pytest -q tests/unit/test_imports.py`：确保所有模块 import 路径更新后可正常加载               |
| 2                     | `core` 内子模块未细分           | 在 `core/` 下拆分 `cards/`, `logic/`, `state/`, `ai/` 四子包，添加 `__init__.py`                                                        | 单元测试运行覆盖率报告必须 ≥ 原先 90%                                                        |
| 3                     | `PokerController` 位于杂糅文件 | 新建 `controller/poker_controller.py`，搬迁并精简控制器逻辑，仅保留流程 & DI 接口                                                                  | 新增 `tests/unit/test_controller_basic.py`：创建控制器实例并断言流程方法存在                     |
| 4                     | DTO 与事件类型散落              | 在 `controller/dto.py` 定义 `GameStateSnapshot`, `PlayerActionInput`, `ActionResult`，在 `core/state/events.py` 定义 `GameEventType` | `tests/unit/test_dto_schema.py`：对 DTO 做 dataclass 字段完整性校验                     |
| 5                     | GameState 公共字段易被 UI 误改   | 调整 `core/state/game_state.py`：私有化可变字段，新增只读 property；公开 `apply_mutation()` 受控入口                                                | `tests/integration/test_state_mutation_guard.py`：利用反射尝试直接改字段应抛 AttributeError |
| **依赖注入与解耦**           |                          |                                                                                                                               |                                                                               |
| 6                     | AI 策略硬编码                 | 定义 `AIPlayerStrategy` 抽象基类；控制器构造函数接受 `ai_strategy_factory: Callable[[seat], AIPlayerStrategy]`                                | `tests/unit/test_ai_injection.py`：注入 DummyAI，断言控制器调用的是 DummyAI.decide\_action |
| 7                     | 随机洗牌不可控                  | 在 `core.logic` 实现 `RandomGenerator` 接口；控制器接受 `rng` 注入                                                                         | `tests/unit/test_deterministic_shuffle.py`：传入固定种子 RNG，断言洗牌顺序可预测               |
| 8                     | 事件发布‐订阅缺失                | 实现简单 `EventBus`；`PokerController` 在关键节点 `publish(event)`                                                                      | `tests/integration/test_event_bus.py`：订阅者收集事件列表长度符合预期                         |
| 9                     | UI 直接调用 controller 内部细节  | 定义 `controller/public_api.py` 只 re-export 安全接口；CLI & Streamlit 仅从此模块 import                                                   | 脚本扫描（pytest plugin）确保 UI 层不 import “private”模块                                |
| 10                    | Action 验证错误信息不细          | 扩充 `ActionResultType` 枚举＋错误码；`ActionValidator` 返回枚举 + message                                                                 | 新增 `tests/rules/test_error_codes.py`：非法加注触发 `INVALID_RAISE_AMOUNT`            |
| **逻辑层精简与一致性**         |                          |                                                                                                                               |                                                                               |
| 11                    | 牌型评估器算法效率未知              | 使用 benchmark 比较新旧实现；若旧算法慢，替换为预先排序表                                                                                            | `tests/performance/test_evaluator_speed.py`：200k 随机组合时间 < 1.5 s               |
| 12                    | 边池计算分散                   | 统一在 `core.logic.pot_manager.PotManager` 中实现 `settle_side_pots()`                                                              | `tests/rules/test_side_pots.py`：3 人全下示例结果与规则一致                                |
| 13                    | 行动验证重复                   | 抽象出 `_validate_common()`；各子函数复用                                                                                               | 通过 `pytest -q tests/unit/test_action_validator.py` 运行全部通过                     |
| 14                    | 阶段推进与发牌耦合                | 在 `controller.phase_engine` 模块新建 `PhaseEngine`，负责 `next_phase()`、发牌分发                                                         | `tests/integration/test_phase_engine.py`：完整演进 PreFlop→River→Showdown 阶列       |
| 15                    | 玩家状态过多 setter            | 用 `@dataclass(frozen=True)` 替换不变字段；可变字段通过方法修改                                                                                 | `tests/unit/test_player_state_immutability.py`：直接改属性抛异常                       |
| **GameState 快照与序列化**  |                          |                                                                                                                               |                                                                               |
| 16                    | Snapshot 包含秘密信息          | `GameStateSnapshot` 接受 `viewer_seat`；对方手牌改为 `"XX"`                                                                            | `tests/unit/test_snapshot_privacy.py`：非观众座位看不到真实牌                             |
| 17                    | Snapshot 字段不稳定           | 写快照 schema 快照测试（pytest-snapshot）防回归                                                                                           | `tests/contract/test_snapshot_schema.py`：schema 改动需显式更新                       |
| **测试体系重组**            |                          |                                                                                                                               |                                                                               |
| 18                    | 测试文件命名不统一                | 统一前缀 `test_*.py`、子目录映射源码层                                                                                                     | CI 规则：`pytest --cov` 通过且无 xfail                                               |
| 19                    | 冗余旧测试                    | 删除 `test_game_flow_old.py`；留存关键断言到新 flow 测试                                                                                   | 在 PR 里运行覆盖率→无下降                                                               |
| 20                    | 功能交叉重复                   | 利用 `pytest markers` 标注层级 `unit/integration/system`，避免多层重复同场景                                                                  | CI 分阶段跑 markers 并统计时间                                                         |
| 21                    | CLI 交互缺集成测试              | 用 `pexpect` 模拟 CLI；输入脚本文件驱动 1 手牌                                                                                              | `tests/e2e/test_cli_interaction.py`：预期文本出现在输出                                 |
| 22                    | 随机性导致测试不稳定               | 所有测试注入 `rng=random.Random(42)` 固定种子                                                                                           | `tests/conftest.py` 全局 fixture                                                |
| 23                    | Streamlit UI 无测试计划       | 准备使用 `streamlit-testing` 对按钮点击 & session\_state 断言                                                                            | `tests/ui/test_streamlit_basic.py`：启动 app，模拟一轮弃牌                              |
| **Streamlit MVP 架构**  |                          |                                                                                                                               |                                                                               |
| 24                    | SessionState 缺封装         | 在 `ui.streamlit.session.py` 编写 `get_controller()` 工具函数                                                                        | 手动运行 app：刷新页面控制器未丢失                                                           |
| 25                    | 牌面渲染缺资产                  | 初版先用文本 `"♥A"`；放置牌面 emoji 映射 dict                                                                                              | `tests/unit/test_card_render.py`：`render_card(Heart, A)` 返回字符串含 “♥”           |
| 26                    | 玩家列表显示不直观                | 使用 `st.columns` 网格展示；当前行动玩家背景高亮                                                                                               | 人工检查 UI                                                                       |
| 27                    | 操作按钮与合法性                 | UI 调用 `controller.get_available_actions()` 动态绘制；金额输入绑定条件显示                                                                    | `tests/ui/test_action_buttons_logic.py`：模拟 state → 应显示相应按钮                    |
| 28                    | AI 操作未分帧                 | 在 UI 回调里循环 `controller.progress_until_human()`，期间 `st.rerun()`                                                                | 手动验证 AI 连续行动直至轮到人                                                             |
| 29                    | 事件日志缺位置                  | 在侧边栏 `st.sidebar` 滚动显示 `controller.consume_events()`                                                                          | 人工验证 flop/turn/river 消息依次出现                                                   |
| 30                    | 一手牌结束缺复位                 | UI 检测 `snapshot.phase == SHOWDOWN and snapshot.awaiting_user == False` → 按钮“下一局”                                              | `tests/ui/test_next_hand_button.py`：点击后 GameState.phase == PREFLOP            |
| 31                    | 玩家输光后继续                  | 控制器方法 `is_game_over()`；UI 若 True → 显示 `st.success('Game Over')`                                                               | 手动验证                                                                          |
| **控制器粒度调整**           |                          |                                                                                                                               |                                                                               |
| 32                    | `play_full_hand` 封装过大    | 拆成 `start_new_hand`, `player_action`, `auto_progress` 三方法                                                                     | 修改所有 CLI & 测试调用，CI 通过                                                         |
| 33                    | 重启游戏未暴露接口                | 增加 `reset_game()`：重置牌堆与筹码                                                                                                     | `tests/system/test_reset_game.py`：多局后 reset → 所有玩家筹码重置                        |
| 34                    | 计时器缺失                    | (预留) 在控制器记录 `hand_start_time`; UI 可展示                                                                                         | `tests/unit/test_timer.py`：hand 时间正递增                                         |
| **依赖管理与打包**           |                          |                                                                                                                               |                                                                               |
| 35                    | requirements 未分层         | 拆分 `requirements-core.txt`, `requirements-ui.txt`                                                                             | CI 步骤：`pip install -r` 两份全通过                                                  |
| 36                    | setup.cfg 缺 entrypoints  | 配置 `console_scripts=texasholdem-cli=ui.cli.cli_game:main`                                                                     | `pytest -q tests/local/test_cli_entry.py`：subprocess 调用成功                     |
| 37                    | core 逻辑与第三方 zero-dep     | 移除 rich 等 UI 依赖；仅保留 `dataclasses`, `typing`, `numpy?`                                                                         | 运行 `pipdeptree` CI 阶段，核心包无 UI 依赖                                              |
| **CI/CD & 质量守护**      |                          |                                                                                                                               |                                                                               |
| 38                    | 无黑格式化规则                  | 加入 `black` & `isort` pre-commit                                                                                               | `pre-commit run --all-files` 通过                                               |
| 39                    | 类型注解不完整                  | 运行 `mypy` 对 `core/` 开启严格模式                                                                                                    | CI 阶段 `mypy --strict core/` 无错误                                               |
| 40                    | 文档漂移                     | 用 `mkdocs` 自动从 docstring 生成 API 文档                                                                                            | 手动 `mkdocs serve` 浏览                                                          |
| **Streamlit MVP 完成度** |                          |                                                                                                                               |                                                                               |
| 41                    | 快照→UI 映射重复代码             | 在 `ui.streamlit.helpers` 写 `render_snapshot(snapshot)`                                                                        | `tests/ui/test_render_snapshot.py`：mock snapshot → 返回组件树                      |
| 42                    | 金额输入 UX 粗糙               | 使用 `st.slider` 限制输入范围 (min\_call, max\_chips)                                                                                 | 人工验证                                                                          |
| 43                    | 公牌图片替换方案                 | 预留可切到 svg/png 资源；路径配置在 `config.py`                                                                                            | 人工验证                                                                          |
| 44                    | 多牌桌支持准备                  | 定义 `TableManager` 服务：字典 `{table_id: PokerController}`                                                                         | `tests/system/test_table_manager.py`：开两桌不互串 state                             |
| **契约/快照测试**           |                          |                                                                                                                               |                                                                               |
| 45                    | DTO 改动难察觉                | 在 `tests/contract/` 使用 `approvaltests`；任何 diff 需审批                                                                            | PR 需要 `--fail-on-report`                                                      |
| 46                    | Snapshot 可视回归            | 生成 HTML 渲染文件存 artifacts，供审核                                                                                                   | GitHub Actions 上传 artifacts                                                   |
| **性能与资源**             |                          |                                                                                                                               |                                                                               |
| 47                    | Streamlit 频繁 rerun 卡顿    | 限制 `rerun` 频率：如果 `time.time() - last_rerun < 0.5` 则跳过                                                                         | `tests/performance/test_ui_throttle.py`：模拟 rapid click → rerun <= 2/s         |
| 48                    | 评估器大输入内存占用               | 用 `@lru_cache(maxsize=100_000)` 缓存牌型字符串→Rank                                                                                  | `tests/performance/test_memory_profile.py`：memory 增量低于阈值                      |
| **交付与回顾**             |                          |                                                                                                                               |                                                                               |
| 49                    | MVP 发布方式                 | 在 repo `README` 添加“本地运行 Streamlit”教程，一键 `streamlit run ui/streamlit/app.py`                                                   | 文档 CI 检查 README 块包含命令                                                         |
| 50                    | 验收 checklist 缺失          | 编写 `docs/ACCEPTANCE.md`：罗列功能、测试通过率、手动检查步骤                                                                                     | 交付前运行 `pytest`, `black`, `mypy`, `mkdocs build` 全绿即合格                         |

---

**执行提示**

* 按序号逐条提交 PR，小步快跑，持续绿 CI
* 建议每 5 – 10 项一次合并，便于回滚
* Streamlit MVP 目标完成标志：#24 — #33 — #43 全部测试通过、手动运行 UI 正常玩一手牌

如需进一步拆分或深入细节，可随时提出，我们继续补充下一批 PLAN。
